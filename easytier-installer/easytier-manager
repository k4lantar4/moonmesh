#!/bin/bash

# ๐๏ธ ูุฏุฑ EasyTier - ููู ุชุนุงูู
# ูุณุฎู: 1.0
# ูุฏู: ูุฏุฑุช ุณุงุฏู EasyTier ุจุง 6 ฺฏุฒูู ุงุตู

set -e

# ุฑูฺฏโูุง
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
PURPLE='\033[0;35m'
NC='\033[0m' # No Color

# ูุณุฑูุง
CONFIG_DIR="/etc/easytier"
LOG_FILE="/var/log/easytier.log"
SERVICE_NAME="easytier"

# =============================================================================
# ุชูุงุจุน ฺฉูฺฉ
# =============================================================================

print_header() {
    clear
    echo -e "${CYAN}โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
    echo "โ                          ๐๏ธ  EasyTier Manager                           โ"
    echo "โ                         ูุฏุฑุช ุณุงุฏู ุดุจฺฉู ุชุงูู                          โ"
    echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ${NC}"
    echo
}

log_info() {
    echo -e "${BLUE}[INFO]${NC} $1"
}

log_success() {
    echo -e "${GREEN}[SUCCESS]${NC} $1"
}

log_warning() {
    echo -e "${YELLOW}[WARNING]${NC} $1"
}

log_error() {
    echo -e "${RED}[ERROR]${NC} $1"
}

press_any_key() {
    echo -e "\n${YELLOW}ุจุฑุง ุงุฏุงูู ูุฑ ฺฉูุฏ ุฑุง ูุดุงุฑ ุฏูุฏ...${NC}"
    read -n 1 -s
}

# =============================================================================
# ฺฏุฒูู 1: ุดุฑูุน ุณุฑูุณ
# =============================================================================

start_service() {
    echo -e "${GREEN}=== ุดุฑูุน ุณุฑูุณ EasyTier ===${NC}"
    echo
    
    if systemctl is-active --quiet "$SERVICE_NAME"; then
        log_warning "ุณุฑูุณ EasyTier ูุจูุงู ุฏุฑ ุญุงู ุงุฌุฑุง ุงุณุช"
        systemctl status "$SERVICE_NAME" --no-pager -l
    else
        log_info "ุดุฑูุน ุณุฑูุณ EasyTier..."
        if systemctl start "$SERVICE_NAME"; then
            log_success "ุณุฑูุณ ุจุง ููููุช ุดุฑูุน ุดุฏ"
            sleep 2
            systemctl status "$SERVICE_NAME" --no-pager -l
        else
            log_error "ุฎุทุง ุฏุฑ ุดุฑูุน ุณุฑูุณ"
            log_info "ูุงฺฏ ุฎุทุง:"
            journalctl -u "$SERVICE_NAME" --no-pager -l | tail -10
        fi
    fi
    
    press_any_key
}

# =============================================================================
# ฺฏุฒูู 2: ุชููู ุณุฑูุณ
# =============================================================================

stop_service() {
    echo -e "${RED}=== ุชููู ุณุฑูุณ EasyTier ===${NC}"
    echo
    
    if ! systemctl is-active --quiet "$SERVICE_NAME"; then
        log_warning "ุณุฑูุณ EasyTier ุฏุฑ ุญุงู ุงุฌุฑุง ูุณุช"
    else
        log_info "ุชููู ุณุฑูุณ EasyTier..."
        if systemctl stop "$SERVICE_NAME"; then
            log_success "ุณุฑูุณ ุจุง ููููุช ูุชููู ุดุฏ"
        else
            log_error "ุฎุทุง ุฏุฑ ุชููู ุณุฑูุณ"
        fi
    fi
    
    # ููุงุด ูุถุนุช ููุง
    systemctl status "$SERVICE_NAME" --no-pager -l || true
    
    press_any_key
}

# =============================================================================
# ฺฏุฒูู 3: ููุงุด ูุถุนุช
# =============================================================================

show_status() {
    echo -e "${BLUE}=== ูุถุนุช EasyTier ===${NC}"
    echo
    
    # ูุถุนุช ุณุฑูุณ
    echo -e "${CYAN}๐ ูุถุนุช ุณุฑูุณ:${NC}"
    systemctl status "$SERVICE_NAME" --no-pager -l || true
    echo
    
    # ุจุฑุฑุณ ุงุชุตุงู
    if systemctl is-active --quiet "$SERVICE_NAME"; then
        echo -e "${CYAN}๐ ุงุทูุงุนุงุช ุงุชุตุงู:${NC}"
        
        # ููุงุด peers (ุงฺฏุฑ easytier-cli ููุฌูุฏ ุจุงุดุฏ)
        if command -v easytier-cli &> /dev/null; then
            echo "Peers ูุชุตู:"
            easytier-cli peer 2>/dev/null || echo "  ุนุฏู ุฏุณุชุฑุณ ุจู ุงุทูุงุนุงุช peer"
            echo
            
            echo "Routes ูุนุงู:"
            easytier-cli route 2>/dev/null || echo "  ุนุฏู ุฏุณุชุฑุณ ุจู ุงุทูุงุนุงุช route"
        else
            log_warning "easytier-cli ุงูุช ูุดุฏ"
        fi
        
        echo
        echo -e "${CYAN}๐ก ุขูุงุฑ ุดุจฺฉู (ุขุฎุฑู 5 ุฎุท ูุงฺฏ):${NC}"
        journalctl -u "$SERVICE_NAME" --no-pager -l | tail -5
    else
        log_warning "ุณุฑูุณ ุฏุฑ ุญุงู ุงุฌุฑุง ูุณุช"
    fi
    
    press_any_key
}

# =============================================================================
# ฺฏุฒูู 4: ูุฏุฑุช Peers
# =============================================================================

manage_peers() {
    echo -e "${PURPLE}=== ูุฏุฑุช Peers ===${NC}"
    echo
    
    if ! command -v easytier-cli &> /dev/null; then
        log_error "easytier-cli ุงูุช ูุดุฏ"
        press_any_key
        return
    fi
    
    if ! systemctl is-active --quiet "$SERVICE_NAME"; then
        log_warning "ุณุฑูุณ EasyTier ุฏุฑ ุญุงู ุงุฌุฑุง ูุณุช"
        echo "ุงุจุชุฏุง ุณุฑูุณ ุฑุง ุดุฑูุน ฺฉูุฏ"
        press_any_key
        return
    fi
    
    while true; do
        echo -e "${PURPLE}=== ููู ูุฏุฑุช Peers ===${NC}"
        echo "1) ููุงุด peers ูุชุตู"
        echo "2) ุงุถุงูู ฺฉุฑุฏู peer ุฌุฏุฏ"
        echo "3) ping ุชุณุช"
        echo "4) ุจุงุฒฺฏุดุช ุจู ููู ุงุตู"
        echo
        read -p "ุงูุชุฎุงุจ ฺฉูุฏ [1-4]: " peer_choice
        
        case $peer_choice in
            1)
                echo -e "\n${CYAN}Peers ูุชุตู:${NC}"
                easytier-cli peer 2>/dev/null || log_error "ุฎุทุง ุฏุฑ ุฏุฑุงูุช ุงุทูุงุนุงุช peers"
                echo
                ;;
            2)
                echo
                read -p "IP:Port peer ุฌุฏุฏ (ูุซุงู: 1.2.3.4:11011): " new_peer
                if [[ -n "$new_peer" ]]; then
                    log_info "ุงุถุงูู ฺฉุฑุฏู peer: $new_peer"
                    log_warning "๐ก ุจุฑุง ุงุถุงูู ฺฉุฑุฏู ุฏุงุฆูุ ูุงู config ุฑุง ูุฑุงุด ฺฉูุฏ:"
                    echo "   sudo nano $CONFIG_DIR/config.yml"
                else
                    log_error "IP:Port ูุนุชุจุฑ ูุงุฑุฏ ูฺฉุฑุฏุฏ"
                fi
                echo
                ;;
            3)
                echo
                read -p "IP ููุตุฏ ุจุฑุง ping (ูุซุงู: 10.145.0.1): " ping_ip
                if [[ -n "$ping_ip" ]]; then
                    log_info "ุชุณุช ping ุจู $ping_ip..."
                    ping -c 3 "$ping_ip" || log_error "ping ูุงูููู"
                else
                    log_error "IP ูุนุชุจุฑ ูุงุฑุฏ ูฺฉุฑุฏุฏ"
                fi
                echo
                ;;
            4)
                return
                ;;
            *)
                log_error "ฺฏุฒูู ูุงูุนุชุจุฑ"
                ;;
        esac
        
        press_any_key
        echo
    done
}

# =============================================================================
# ฺฏุฒูู 5: ูุฏุฑุช ุดุจฺฉู
# =============================================================================

manage_network() {
    echo -e "${YELLOW}=== ูุฏุฑุช ุดุจฺฉู ===${NC}"
    echo
    
    while true; do
        echo -e "${YELLOW}=== ููู ูุฏุฑุช ุดุจฺฉู ===${NC}"
        echo "1) ููุงุด ูพฺฉุฑุจูุฏ ูุนู"
        echo "2) ูุฑุงุด ุชูุธูุงุช ุดุจฺฉู"
        echo "3) restart ุณุฑูุณ (ุงุนูุงู ุชุบุฑุงุช)"
        echo "4) ุชุณุช ุงุชุตุงู"
        echo "5) ุจุงุฒฺฏุดุช ุจู ููู ุงุตู"
        echo
        read -p "ุงูุชุฎุงุจ ฺฉูุฏ [1-5]: " network_choice
        
        case $network_choice in
            1)
                echo -e "\n${CYAN}ูพฺฉุฑุจูุฏ ูุนู:${NC}"
                if [[ -f "$CONFIG_DIR/config.yml" ]]; then
                    cat "$CONFIG_DIR/config.yml"
                else
                    log_error "ูุงู config ุงูุช ูุดุฏ"
                fi
                echo
                ;;
            2)
                echo
                log_info "ูุฑุงุด ูุงู ูพฺฉุฑุจูุฏ..."
                if command -v nano &> /dev/null; then
                    nano "$CONFIG_DIR/config.yml"
                elif command -v vi &> /dev/null; then
                    vi "$CONFIG_DIR/config.yml"
                else
                    log_error "ูุฑุงุดฺฏุฑ ูุชู ุงูุช ูุดุฏ"
                fi
                ;;
            3)
                echo
                log_info "ุฑุงูโุงูุฏุงุฒ ูุฌุฏุฏ ุณุฑูุณ..."
                systemctl restart "$SERVICE_NAME" && log_success "ุณุฑูุณ ุฑุงูโุงูุฏุงุฒ ุดุฏ" || log_error "ุฎุทุง ุฏุฑ ุฑุงูโุงูุฏุงุฒ"
                ;;
            4)
                echo
                log_info "ุชุณุช ุงุชุตุงู ุจู ุดุจฺฉู..."
                if systemctl is-active --quiet "$SERVICE_NAME"; then
                    log_success "ุณุฑูุณ ูุนุงู ุงุณุช"
                    
                    # ุชุณุช ping ุจู gateway ุชุงูู
                    local gateway_ip=$(grep "ipv4:" "$CONFIG_DIR/config.yml" 2>/dev/null | cut -d'"' -f2 | head -1)
                    if [[ -n "$gateway_ip" ]]; then
                        log_info "ุชุณุช ping ุจู $gateway_ip..."
                        ping -c 2 "$gateway_ip" && log_success "ping ูููู" || log_warning "ping ูุงูููู"
                    fi
                else
                    log_error "ุณุฑูุณ ูุนุงู ูุณุช"
                fi
                echo
                ;;
            5)
                return
                ;;
            *)
                log_error "ฺฏุฒูู ูุงูุนุชุจุฑ"
                ;;
        esac
        
        press_any_key
        echo
    done
}

# =============================================================================
# ููู ุงุตู
# =============================================================================

show_main_menu() {
    while true; do
        print_header
        
        # ููุงุด ูุถุนุช ฺฉู
        local service_status
        if systemctl is-active --quiet "$SERVICE_NAME"; then
            service_status="${GREEN}๐ข ูุนุงู${NC}"
        else
            service_status="${RED}๐ด ุบุฑูุนุงู${NC}"
        fi
        
        echo -e "${CYAN}๐ ูุถุนุช ุณุฑูุณ:${NC} $service_status"
        echo -e "${CYAN}๐ ูุณุฑ Config:${NC} $CONFIG_DIR/config.yml"
        echo -e "${CYAN}๐ ูุงฺฏ ูุงู:${NC} $LOG_FILE"
        echo
        echo -e "${BLUE}โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ${NC}"
        echo
        echo "1) ๐ ุดุฑูุน ุณุฑูุณ"
        echo "2) ๐ ุชููู ุณุฑูุณ"  
        echo "3) ๐ ููุงุด ูุถุนุช"
        echo "4) ๐ ูุฏุฑุช Peers"
        echo "5) ๐ ูุฏุฑุช ุดุจฺฉู"
        echo "6) ๐ช ุฎุฑูุฌ"
        echo
        read -p "ฺฏุฒูู ุฎูุฏ ุฑุง ุงูุชุฎุงุจ ฺฉูุฏ [1-6]: " choice
        
        echo
        case $choice in
            1) start_service ;;
            2) stop_service ;;
            3) show_status ;;
            4) manage_peers ;;
            5) manage_network ;;
            6) 
                echo -e "${GREEN}ุฎุฏุงุญุงูุธ! ๐${NC}"
                exit 0
                ;;
            *)
                log_error "ฺฏุฒูู ูุงูุนุชุจุฑ. ูุทูุงู ุนุฏุฏ ุจู 1 ุชุง 6 ูุงุฑุฏ ฺฉูุฏ."
                press_any_key
                ;;
        esac
    done
}

# =============================================================================
# ุงุฌุฑุง ุจุฑูุงูู
# =============================================================================

# ุจุฑุฑุณ ุฏุณุชุฑุณ root
if [[ $EUID -ne 0 ]]; then
    echo -e "${RED}[ERROR]${NC} ุงู ุงุณฺฉุฑูพุช ุจุงุฏ ุจุง ุฏุณุชุฑุณ root ุงุฌุฑุง ุดูุฏ"
    echo "ุงุณุชูุงุฏู: sudo $0"
    exit 1
fi

# ุดุฑูุน ููู ุงุตู
show_main_menu 