#!/bin/bash

# ğŸ›ï¸ Ù…Ø¯ÛŒØ± EasyTier - Ù…Ù†ÙˆÛŒ ØªØ¹Ø§Ù…Ù„ÛŒ
# Ù†Ø³Ø®Ù‡: 1.0
# Ù‡Ø¯Ù: Ù…Ø¯ÛŒØ±ÛŒØª Ø³Ø§Ø¯Ù‡ EasyTier Ø¨Ø§ 6 Ú¯Ø²ÛŒÙ†Ù‡ Ø§ØµÙ„ÛŒ

set -e

# Ø±Ù†Ú¯â€ŒÙ‡Ø§
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
PURPLE='\033[0;35m'
NC='\033[0m' # No Color

# Ù…Ø³ÛŒØ±Ù‡Ø§
CONFIG_DIR="/etc/easytier"
LOG_FILE="/var/log/easytier.log"
SERVICE_NAME="easytier"

# =============================================================================
# ØªÙˆØ§Ø¨Ø¹ Ú©Ù…Ú©ÛŒ
# =============================================================================

print_header() {
    clear
    echo -e "${CYAN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘                          ğŸ›ï¸  EasyTier Manager                           â•‘"
    echo "â•‘                        Simple Tunnel Network Management                  â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo
}

log_info() {
    echo -e "${BLUE}[INFO]${NC} $1"
}

log_success() {
    echo -e "${GREEN}[SUCCESS]${NC} $1"
}

log_warning() {
    echo -e "${YELLOW}[WARNING]${NC} $1"
}

log_error() {
    echo -e "${RED}[ERROR]${NC} $1"
}

press_any_key() {
    echo -e "\n${YELLOW}Press any key to continue...${NC}"
    read -n 1 -s
}

# =============================================================================
# Ú¯Ø²ÛŒÙ†Ù‡ 1: Ø´Ø±ÙˆØ¹ Ø³Ø±ÙˆÛŒØ³
# =============================================================================

start_service() {
    echo -e "${GREEN}=== Ø´Ø±ÙˆØ¹ Ø³Ø±ÙˆÛŒØ³ EasyTier ===${NC}"
    echo
    
    if systemctl is-active --quiet "$SERVICE_NAME"; then
        log_warning "Ø³Ø±ÙˆÛŒØ³ EasyTier Ù‚Ø¨Ù„Ø§Ù‹ Ø¯Ø± Ø­Ø§Ù„ Ø§Ø¬Ø±Ø§ Ø§Ø³Øª"
        systemctl status "$SERVICE_NAME" --no-pager -l
    else
        log_info "Ø´Ø±ÙˆØ¹ Ø³Ø±ÙˆÛŒØ³ EasyTier..."
        if systemctl start "$SERVICE_NAME"; then
            log_success "Ø³Ø±ÙˆÛŒØ³ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø´Ø±ÙˆØ¹ Ø´Ø¯"
            sleep 2
            systemctl status "$SERVICE_NAME" --no-pager -l
        else
            log_error "Ø®Ø·Ø§ Ø¯Ø± Ø´Ø±ÙˆØ¹ Ø³Ø±ÙˆÛŒØ³"
            log_info "Ù„Ø§Ú¯ Ø®Ø·Ø§:"
            journalctl -u "$SERVICE_NAME" --no-pager -l | tail -10
        fi
    fi
    
    press_any_key
}

# =============================================================================
# Ú¯Ø²ÛŒÙ†Ù‡ 2: ØªÙˆÙ‚Ù Ø³Ø±ÙˆÛŒØ³
# =============================================================================

stop_service() {
    echo -e "${RED}=== ØªÙˆÙ‚Ù Ø³Ø±ÙˆÛŒØ³ EasyTier ===${NC}"
    echo
    
    if ! systemctl is-active --quiet "$SERVICE_NAME"; then
        log_warning "Ø³Ø±ÙˆÛŒØ³ EasyTier Ø¯Ø± Ø­Ø§Ù„ Ø§Ø¬Ø±Ø§ Ù†ÛŒØ³Øª"
    else
        log_info "ØªÙˆÙ‚Ù Ø³Ø±ÙˆÛŒØ³ EasyTier..."
        if systemctl stop "$SERVICE_NAME"; then
            log_success "Ø³Ø±ÙˆÛŒØ³ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ù…ØªÙˆÙ‚Ù Ø´Ø¯"
        else
            log_error "Ø®Ø·Ø§ Ø¯Ø± ØªÙˆÙ‚Ù Ø³Ø±ÙˆÛŒØ³"
        fi
    fi
    
    # Ù†Ù…Ø§ÛŒØ´ ÙˆØ¶Ø¹ÛŒØª Ù†Ù‡Ø§ÛŒÛŒ
    systemctl status "$SERVICE_NAME" --no-pager -l || true
    
    press_any_key
}

# =============================================================================
# Ú¯Ø²ÛŒÙ†Ù‡ 3: Ù†Ù…Ø§ÛŒØ´ ÙˆØ¶Ø¹ÛŒØª
# =============================================================================

show_status() {
    echo -e "${BLUE}=== ÙˆØ¶Ø¹ÛŒØª EasyTier ===${NC}"
    echo
    
    # ÙˆØ¶Ø¹ÛŒØª Ø³Ø±ÙˆÛŒØ³
    echo -e "${CYAN}ğŸ“Š ÙˆØ¶Ø¹ÛŒØª Ø³Ø±ÙˆÛŒØ³:${NC}"
    systemctl status "$SERVICE_NAME" --no-pager -l || true
    echo
    
    # Ø¨Ø±Ø±Ø³ÛŒ Ø§ØªØµØ§Ù„
    if systemctl is-active --quiet "$SERVICE_NAME"; then
        echo -e "${CYAN}ğŸ”— Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø§ØªØµØ§Ù„:${NC}"
        
        # Ù†Ù…Ø§ÛŒØ´ peers (Ø§Ú¯Ø± easytier-cli Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø§Ø´Ø¯)
        if command -v easytier-cli &> /dev/null; then
            echo "Peers Ù…ØªØµÙ„:"
            easytier-cli peer 2>/dev/null || echo "  Ø¹Ø¯Ù… Ø¯Ø³ØªØ±Ø³ÛŒ Ø¨Ù‡ Ø§Ø·Ù„Ø§Ø¹Ø§Øª peer"
            echo
            
            echo "Routes ÙØ¹Ø§Ù„:"
            easytier-cli route 2>/dev/null || echo "  Ø¹Ø¯Ù… Ø¯Ø³ØªØ±Ø³ÛŒ Ø¨Ù‡ Ø§Ø·Ù„Ø§Ø¹Ø§Øª route"
        else
            log_warning "easytier-cli ÛŒØ§ÙØª Ù†Ø´Ø¯"
        fi
        
        echo
        echo -e "${CYAN}ğŸ“¡ Ø¢Ù…Ø§Ø± Ø´Ø¨Ú©Ù‡ (Ø¢Ø®Ø±ÛŒÙ† 5 Ø®Ø· Ù„Ø§Ú¯):${NC}"
        journalctl -u "$SERVICE_NAME" --no-pager -l | tail -5
    else
        log_warning "Ø³Ø±ÙˆÛŒØ³ Ø¯Ø± Ø­Ø§Ù„ Ø§Ø¬Ø±Ø§ Ù†ÛŒØ³Øª"
    fi
    
    press_any_key
}

# =============================================================================
# Ú¯Ø²ÛŒÙ†Ù‡ 4: Ù…Ø¯ÛŒØ±ÛŒØª Peers
# =============================================================================

manage_peers() {
    echo -e "${PURPLE}=== Peers Management ===${NC}"
    echo
    if ! command -v easytier-cli &> /dev/null; then
        log_error "easytier-cli not found"
        press_any_key
        return
    fi
    if ! systemctl is-active --quiet "$SERVICE_NAME"; then
        log_warning "EasyTier service is not running"
        echo "Please start the service first"
        press_any_key
        return
    fi
    while true; do
        echo -e "${PURPLE}=== Peers Management Menu ===${NC}"
        echo "1) Show connected peers"
        echo "2) Add new peer"
        echo "3) Ping test"
        echo "4) Back to main menu"
        echo
        read -p "Select [1-4]: " peer_choice
        case $peer_choice in
            1)
                echo -e "\n${CYAN}Connected Peers:${NC}"
                easytier-cli peer 2>/dev/null || log_error "Error fetching peers information"
                echo
                ;;
            2)
                echo
                read -p "New peer IP:Port (e.g. 1.2.3.4:11011): " new_peer
                if [[ -n "$new_peer" ]]; then
                    log_info "Adding peer: $new_peer"
                    log_warning "ğŸ’¡ For permanent addition, edit the config file:"
                    echo "   sudo nano $CONFIG_DIR/config.yml"
                else
                    log_error "Invalid IP:Port entered"
                fi
                echo
                ;;
            3)
                echo
                read -p "Destination IP for ping (e.g. 10.145.0.1): " ping_ip
                if [[ -n "$ping_ip" ]]; then
                    log_info "Pinging $ping_ip..."
                    ping -c 3 "$ping_ip" || log_error "Ping failed"
                else
                    log_error "Invalid IP entered"
                fi
                echo
                ;;
            4)
                return
                ;;
            *)
                log_error "Invalid option"
                ;;
        esac
        press_any_key
        echo
    done
}

# =============================================================================
# Ú¯Ø²ÛŒÙ†Ù‡ 5: Ù…Ø¯ÛŒØ±ÛŒØª Ø´Ø¨Ú©Ù‡ (Ø¨Ù‡Ø¨ÙˆØ¯ ÛŒØ§ÙØªÙ‡ - ØªØ³Ú© 7)
# =============================================================================

manage_network() {
    echo -e "${YELLOW}=== Network Management ===${NC}"
    echo
    while true; do
        echo -e "${YELLOW}=== Network Management Menu ===${NC}"
        echo "1) Show current configuration"
        echo "2) Create new network (name + secret + IP)"
        echo "3) Join existing network"
        echo "4) Show active routes"
        echo "5) Ping & connectivity test"
        echo "6) Edit network settings manually"
        echo "7) Restart service (apply changes)"
        echo "8) Back to main menu"
        echo
        read -p "Select [1-8]: " network_choice
        case $network_choice in
            1)
                echo -e "\n${CYAN}Current configuration:${NC}"
                if [[ -f "$CONFIG_DIR/config.yml" ]]; then
                    cat "$CONFIG_DIR/config.yml"
                else
                    log_error "Config file not found"
                fi
                echo
                ;;
            2)
                echo -e "\n${GREEN}=== Ø§ÛŒØ¬Ø§Ø¯ Network Ø¬Ø¯ÛŒØ¯ ===${NC}"
                create_new_network
                ;;
            3)
                echo -e "\n${BLUE}=== Ø§ØªØµØ§Ù„ Ø¨Ù‡ Network Ù…ÙˆØ¬ÙˆØ¯ ===${NC}"
                join_existing_network
                ;;
            4)
                echo -e "\n${CYAN}=== Ù†Ù…Ø§ÛŒØ´ Routes ÙØ¹Ø§Ù„ ===${NC}"
                show_active_routes
                ;;
            5)
                echo -e "\n${PURPLE}=== ØªØ³Øª Ping Ùˆ Connectivity ===${NC}"
                advanced_ping_test
                ;;
            6)
                echo
                log_info "ÙˆÛŒØ±Ø§ÛŒØ´ ÙØ§ÛŒÙ„ Ù¾ÛŒÚ©Ø±Ø¨Ù†Ø¯ÛŒ..."
                if command -v nano &> /dev/null; then
                    nano "$CONFIG_DIR/config.yml"
                elif command -v vi &> /dev/null; then
                    vi "$CONFIG_DIR/config.yml"
                else
                    log_error "ÙˆÛŒØ±Ø§ÛŒØ´Ú¯Ø± Ù…ØªÙ†ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯"
                fi
                ;;
            7)
                echo
                log_info "Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Ù…Ø¬Ø¯Ø¯ Ø³Ø±ÙˆÛŒØ³..."
                systemctl restart "$SERVICE_NAME" && log_success "Ø³Ø±ÙˆÛŒØ³ Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Ø´Ø¯" || log_error "Ø®Ø·Ø§ Ø¯Ø± Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ"
                ;;
            8)
                return
                ;;
            *)
                log_error "Ú¯Ø²ÛŒÙ†Ù‡ Ù†Ø§Ù…Ø¹ØªØ¨Ø±"
                ;;
        esac
        
        press_any_key
        echo
    done
}

# =============================================================================
# ØªÙˆØ§Ø¨Ø¹ Ø¬Ø¯ÛŒØ¯ ØªØ³Ú© 7
# =============================================================================

# Ø§ÛŒØ¬Ø§Ø¯ network Ø¬Ø¯ÛŒØ¯
create_new_network() {
    echo -e "${GREEN}Ø§ÛŒØ¬Ø§Ø¯ network Ø¬Ø¯ÛŒØ¯${NC}"
    echo
    
    # Ø¯Ø±ÛŒØ§ÙØª Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø§Ø² Ú©Ø§Ø±Ø¨Ø±
    read -p "Ù†Ø§Ù… Ø´Ø¨Ú©Ù‡ (Ù…Ø«Ø§Ù„: my-office-network): " network_name
    if [[ -z "$network_name" ]]; then
        log_error "Ù†Ø§Ù… Ø´Ø¨Ú©Ù‡ Ù†Ù…ÛŒâ€ŒØªÙˆØ§Ù†Ø¯ Ø®Ø§Ù„ÛŒ Ø¨Ø§Ø´Ø¯"
        return 1
    fi
    
    read -p "Ú©Ù„ÛŒØ¯ Ø§Ù…Ù†ÛŒØªÛŒ Ø´Ø¨Ú©Ù‡ (Ø®Ø§Ù„ÛŒ=ØªÙˆÙ„ÛŒØ¯ Ø®ÙˆØ¯Ú©Ø§Ø±): " network_secret
    if [[ -z "$network_secret" ]]; then
        network_secret=$(openssl rand -hex 16 2>/dev/null || echo "secret-$(date +%s)")
        log_info "Ú©Ù„ÛŒØ¯ ØªÙˆÙ„ÛŒØ¯ Ø´Ø¯: $network_secret"
    fi
    
    # Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯ IP Ø¢Ø²Ø§Ø¯
    suggested_ip="10.145.0.$((RANDOM % 253 + 2))"
    read -p "IP Ø´Ù…Ø§ Ø¯Ø± ØªØ§Ù†Ù„ (Ù¾ÛŒØ´ÙØ±Ø¶: $suggested_ip): " tunnel_ip
    tunnel_ip=${tunnel_ip:-$suggested_ip}
    
    # Ø§Ø¹ØªØ¨Ø§Ø±Ø³Ù†Ø¬ÛŒ IP
    if [[ ! "$tunnel_ip" =~ ^10\.145\.0\.[0-9]+$ ]]; then
        log_warning "IP Ø¨Ø§ÛŒØ¯ Ø¯Ø± Ù…Ø­Ø¯ÙˆØ¯Ù‡ 10.145.0.x Ø¨Ø§Ø´Ø¯"
    fi
    
    # Ø§ÛŒØ¬Ø§Ø¯ ÙØ§ÛŒÙ„ config
    log_info "Ø§ÛŒØ¬Ø§Ø¯ ÙØ§ÛŒÙ„ Ù¾ÛŒÚ©Ø±Ø¨Ù†Ø¯ÛŒ..."
    
    sudo tee "$CONFIG_DIR/config.yml" > /dev/null << EOF
# ğŸ”§ EasyTier - Network Ø¬Ø¯ÛŒØ¯: $network_name
# ØªÙˆÙ„ÛŒØ¯ Ø´Ø¯Ù‡ Ø¯Ø±: $(date)

# Ù…Ø´Ø®ØµØ§Øª Ø´Ø¨Ú©Ù‡
network_name: "$network_name"
network_secret: "$network_secret"

# IP ØªØ§Ù†Ù„ (Ù…Ù†Ø­ØµØ± Ø¨Ù‡ ÙØ±Ø¯)
ipv4: "$tunnel_ip"
ipv4_prefix: 24

# Ù¾ÙˆØ±Øª Ø´Ù†ÙˆØ¯
listen_port: 11011

# Ù„ÛŒØ³Øª peers (Ø³Ø§ÛŒØ± Ø§Ø¹Ø¶Ø§ÛŒ Ø´Ø¨Ú©Ù‡)
peers:
  # Ø¨Ø±Ø§ÛŒ Ø§ØªØµØ§Ù„ Ø¨Ù‡ node Ù‡Ø§ÛŒ Ø¯ÛŒÚ¯Ø±ØŒ IP Ø¢Ù†Ù‡Ø§ Ø±Ø§ Ø§ÛŒÙ†Ø¬Ø§ Ø§Ø¶Ø§ÙÙ‡ Ú©Ù†ÛŒØ¯
  # - "IP:11011"

# hostname
hostname: "$(hostname)"

# Ù†Ú©Ø§Øª:
# - Ø§ÛŒÙ† node Ø§ÙˆÙ„ÛŒÙ† Ø¹Ø¶Ùˆ Ø´Ø¨Ú©Ù‡ Ø§Ø³Øª
# - Ø¨Ø±Ø§ÛŒ Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† node Ø¬Ø¯ÛŒØ¯: IP Ø§ÛŒÙ† Ø³Ø±ÙˆØ± + Ú©Ù„ÛŒØ¯ Ù…Ø´ØªØ±Ú©
# - Ù¾ÙˆØ±Øª 11011 Ø±ÙˆÛŒ ÙØ§ÛŒØ±ÙˆØ§Ù„ Ø¨Ø§Ø² Ø¨Ø§Ø´Ø¯
EOF
    
    # ØªÙ†Ø¸ÛŒÙ… Ù…Ø¬ÙˆØ²Ù‡Ø§
    sudo chmod 600 "$CONFIG_DIR/config.yml"
    sudo chown root:root "$CONFIG_DIR/config.yml"
    
    log_success "Network Ø¬Ø¯ÛŒØ¯ Ø§ÛŒØ¬Ø§Ø¯ Ø´Ø¯!"
    echo
    echo -e "${CYAN}ğŸ”‘ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø´Ø¨Ú©Ù‡:${NC}"
    echo "  ğŸ“› Ù†Ø§Ù…: $network_name"
    echo "  ğŸ” Ú©Ù„ÛŒØ¯: $network_secret"
    echo "  ğŸŒ IP Ø´Ù…Ø§: $tunnel_ip"
    echo "  ğŸ”Œ Ù¾ÙˆØ±Øª: 11011"
    echo
    echo -e "${YELLOW}ğŸ’¡ Ø¨Ø±Ø§ÛŒ Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† node Ø¬Ø¯ÛŒØ¯:${NC}"
    echo "  1. IP Ø§ÛŒÙ† Ø³Ø±ÙˆØ± Ø±Ø§ Ù¾ÛŒØ¯Ø§ Ú©Ù†ÛŒØ¯: $(curl -s ipinfo.io/ip 2>/dev/null || hostname -I | awk '{print $1}')"
    echo "  2. Ø¯Ø± node Ø¬Ø¯ÛŒØ¯ Ú¯Ø²ÛŒÙ†Ù‡ 'Ø§ØªØµØ§Ù„ Ø¨Ù‡ network Ù…ÙˆØ¬ÙˆØ¯' Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯"
    echo "  3. Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø¨Ø§Ù„Ø§ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯"
}

# Ø§ØªØµØ§Ù„ Ø¨Ù‡ network Ù…ÙˆØ¬ÙˆØ¯
join_existing_network() {
    echo -e "${BLUE}Ø§ØªØµØ§Ù„ Ø¨Ù‡ network Ù…ÙˆØ¬ÙˆØ¯${NC}"
    echo
    
    # Ø¯Ø±ÛŒØ§ÙØª Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø´Ø¨Ú©Ù‡ Ù…ÙˆØ¬ÙˆØ¯
    read -p "Ù†Ø§Ù… Ø´Ø¨Ú©Ù‡: " network_name
    if [[ -z "$network_name" ]]; then
        log_error "Ù†Ø§Ù… Ø´Ø¨Ú©Ù‡ Ù†Ù…ÛŒâ€ŒØªÙˆØ§Ù†Ø¯ Ø®Ø§Ù„ÛŒ Ø¨Ø§Ø´Ø¯"
        return 1
    fi
    
    read -p "Ú©Ù„ÛŒØ¯ Ø§Ù…Ù†ÛŒØªÛŒ Ø´Ø¨Ú©Ù‡: " network_secret
    if [[ -z "$network_secret" ]]; then
        log_error "Ú©Ù„ÛŒØ¯ Ø§Ù…Ù†ÛŒØªÛŒ Ù†Ù…ÛŒâ€ŒØªÙˆØ§Ù†Ø¯ Ø®Ø§Ù„ÛŒ Ø¨Ø§Ø´Ø¯"
        return 1
    fi
    
    # Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯ IP Ø¢Ø²Ø§Ø¯
    suggested_ip="10.145.0.$((RANDOM % 253 + 2))"
    read -p "IP Ø´Ù…Ø§ Ø¯Ø± ØªØ§Ù†Ù„ (Ù¾ÛŒØ´ÙØ±Ø¶: $suggested_ip): " tunnel_ip
    tunnel_ip=${tunnel_ip:-$suggested_ip}
    
    # IP peer Ø§ØµÙ„ÛŒ
    read -p "IP Ø³Ø±ÙˆØ± Ø§ØµÙ„ÛŒ Ø´Ø¨Ú©Ù‡ (Ù…Ø«Ø§Ù„: 1.2.3.4): " peer_ip
    if [[ -z "$peer_ip" ]]; then
        log_error "IP Ø³Ø±ÙˆØ± Ø§ØµÙ„ÛŒ Ø¶Ø±ÙˆØ±ÛŒ Ø§Ø³Øª"
        return 1
    fi
    
    # Ø§ÛŒØ¬Ø§Ø¯ ÙØ§ÛŒÙ„ config
    log_info "Ø§ÛŒØ¬Ø§Ø¯ ÙØ§ÛŒÙ„ Ù¾ÛŒÚ©Ø±Ø¨Ù†Ø¯ÛŒ..."
    
    sudo tee "$CONFIG_DIR/config.yml" > /dev/null << EOF
# ğŸ”§ EasyTier - Ø§ØªØµØ§Ù„ Ø¨Ù‡: $network_name
# ØªÙˆÙ„ÛŒØ¯ Ø´Ø¯Ù‡ Ø¯Ø±: $(date)

# Ù…Ø´Ø®ØµØ§Øª Ø´Ø¨Ú©Ù‡
network_name: "$network_name"
network_secret: "$network_secret"

# IP ØªØ§Ù†Ù„ (Ù…Ù†Ø­ØµØ± Ø¨Ù‡ ÙØ±Ø¯)
ipv4: "$tunnel_ip"
ipv4_prefix: 24

# Ù¾ÙˆØ±Øª Ø´Ù†ÙˆØ¯
listen_port: 11011

# Ø§ØªØµØ§Ù„ Ø¨Ù‡ peer Ø§ØµÙ„ÛŒ
peers:
  - "$peer_ip:11011"

# hostname
hostname: "$(hostname)"
EOF
    
    # ØªÙ†Ø¸ÛŒÙ… Ù…Ø¬ÙˆØ²Ù‡Ø§
    sudo chmod 600 "$CONFIG_DIR/config.yml"
    sudo chown root:root "$CONFIG_DIR/config.yml"
    
    log_success "ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø§ØªØµØ§Ù„ Ú©Ø§Ù…Ù„ Ø´Ø¯!"
    echo
    echo -e "${CYAN}ğŸ”— Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø§ØªØµØ§Ù„:${NC}"
    echo "  ğŸ“› Ø´Ø¨Ú©Ù‡: $network_name"
    echo "  ğŸŒ IP Ø´Ù…Ø§: $tunnel_ip"
    echo "  ğŸ¯ Peer Ø§ØµÙ„ÛŒ: $peer_ip:11011"
    echo
    echo -e "${YELLOW}ğŸ’¡ Ù…Ø±Ø­Ù„Ù‡ Ø¨Ø¹Ø¯:${NC}"
    echo "  - Ø³Ø±ÙˆÛŒØ³ Ø±Ø§ restart Ú©Ù†ÛŒØ¯ (Ú¯Ø²ÛŒÙ†Ù‡ 7)"
    echo "  - Ú†Ù†Ø¯ Ø«Ø§Ù†ÛŒÙ‡ ØµØ¨Ø± Ú©Ù†ÛŒØ¯"
    echo "  - ÙˆØ¶Ø¹ÛŒØª Ø§ØªØµØ§Ù„ Ø±Ø§ Ø¨Ø±Ø±Ø³ÛŒ Ú©Ù†ÛŒØ¯ (Ú¯Ø²ÛŒÙ†Ù‡ 4)"
}

# Ù†Ù…Ø§ÛŒØ´ route Ù‡Ø§ÛŒ ÙØ¹Ø§Ù„
show_active_routes() {
    echo -e "${CYAN}Routes ÙØ¹Ø§Ù„ Ø¯Ø± Ø³ÛŒØ³ØªÙ…${NC}"
    echo
    
    if ! command -v easytier-cli &> /dev/null; then
        log_error "easytier-cli ÛŒØ§ÙØª Ù†Ø´Ø¯"
        return 1
    fi
    
    if ! systemctl is-active --quiet "$SERVICE_NAME"; then
        log_warning "Ø³Ø±ÙˆÛŒØ³ EasyTier ÙØ¹Ø§Ù„ Ù†ÛŒØ³Øª"
        echo "Ø§Ø¨ØªØ¯Ø§ Ø³Ø±ÙˆÛŒØ³ Ø±Ø§ Ø´Ø±ÙˆØ¹ Ú©Ù†ÛŒØ¯"
        return 1
    fi
    
    echo -e "${BLUE}ğŸ›£ï¸  EasyTier Routes:${NC}"
    easytier-cli route 2>/dev/null || log_error "Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª routes"
    
    echo
    echo -e "${BLUE}ğŸŒ System Routes (10.145.0.0/24):${NC}"
    ip route show | grep "10.145.0" || echo "  Ù‡ÛŒÚ† route Ø§ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯"
    
    echo
    echo -e "${BLUE}ğŸ”— Connected Peers:${NC}"
    easytier-cli peer 2>/dev/null || log_error "Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª peers"
    
    echo
    echo -e "${BLUE}ğŸ“Š Network Interfaces:${NC}"
    ip addr show | grep -A 2 "easytier\|tun" || echo "  Ù‡ÛŒÚ† interface ØªØ§Ù†Ù„ ÛŒØ§ÙØª Ù†Ø´Ø¯"
}

# ØªØ³Øª ping Ù¾ÛŒØ´Ø±ÙØªÙ‡
advanced_ping_test() {
    echo -e "${PURPLE}ØªØ³Øª Ø§ØªØµØ§Ù„ Ø´Ø§Ù…Ù„${NC}"
    echo
    
    if ! systemctl is-active --quiet "$SERVICE_NAME"; then
        log_warning "Ø³Ø±ÙˆÛŒØ³ EasyTier ÙØ¹Ø§Ù„ Ù†ÛŒØ³Øª"
        echo "Ø§Ø¨ØªØ¯Ø§ Ø³Ø±ÙˆÛŒØ³ Ø±Ø§ Ø´Ø±ÙˆØ¹ Ú©Ù†ÛŒØ¯"
        return 1
    fi
    
    # Ø¯Ø±ÛŒØ§ÙØª IP ØªØ§Ù†Ù„ Ø§Ø² config
    local my_tunnel_ip=""
    if [[ -f "$CONFIG_DIR/config.yml" ]]; then
        my_tunnel_ip=$(grep "ipv4:" "$CONFIG_DIR/config.yml" | cut -d'"' -f2 | head -1)
    fi
    
    echo -e "${CYAN}1. ØªØ³Øª Ø®ÙˆØ¯ÛŒ (loopback):${NC}"
    if [[ -n "$my_tunnel_ip" ]]; then
        ping -c 3 "$my_tunnel_ip" && log_success "Ping Ø®ÙˆØ¯ÛŒ OK" || log_error "Ping Ø®ÙˆØ¯ÛŒ Ù†Ø§Ù…ÙˆÙÙ‚"
    else
        log_warning "IP ØªØ§Ù†Ù„ Ø¯Ø± config ÛŒØ§ÙØª Ù†Ø´Ø¯"
    fi
    
    echo
    echo -e "${CYAN}2. ØªØ³Øª gateway ØªØ§Ù†Ù„:${NC}"
    ping -c 3 "10.145.0.1" && log_success "Gateway OK" || log_warning "Gateway Ù¾Ø§Ø³Ø® Ù†Ø¯Ø§Ø¯"
    
    echo
    echo -e "${CYAN}3. ØªØ³Øª DNS Ø¹Ù…ÙˆÙ…ÛŒ:${NC}"
    ping -c 2 "8.8.8.8" && log_success "Ø§ØªØµØ§Ù„ Ø§ÛŒÙ†ØªØ±Ù†Øª OK" || log_error "Ù…Ø´Ú©Ù„ Ø§ØªØµØ§Ù„ Ø§ÛŒÙ†ØªØ±Ù†Øª"
    
    echo
    echo -e "${CYAN}4. ØªØ³Øª Ø¨Ù‡ peer Ø¯ÛŒÚ¯Ø±:${NC}"
    read -p "IP peer Ù…Ù‚ØµØ¯ Ø¨Ø±Ø§ÛŒ ØªØ³Øª (Ø®Ø§Ù„ÛŒ=Ø±Ø¯): " target_peer
    if [[ -n "$target_peer" ]]; then
        ping -c 3 "$target_peer" && log_success "Peer connectivity OK" || log_error "Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ peer Ø¨Ø±Ù‚Ø±Ø§Ø± Ù†Ø´Ø¯"
    fi
    
    echo
    echo -e "${CYAN}5. Ø®Ù„Ø§ØµÙ‡ ÙˆØ¶Ø¹ÛŒØª:${NC}"
    if command -v easytier-cli &> /dev/null; then
        local peer_count=$(easytier-cli peer 2>/dev/null | grep -c "peer_id" || echo "0")
        echo "  ğŸ”— ØªØ¹Ø¯Ø§Ø¯ peer Ù…ØªØµÙ„: $peer_count"
        
        local route_count=$(easytier-cli route 2>/dev/null | grep -c "10.145.0" || echo "0")
        echo "  ğŸ›£ï¸  ØªØ¹Ø¯Ø§Ø¯ route: $route_count"
    fi
    
    echo "  ğŸŒ IP ØªØ§Ù†Ù„ Ø´Ù…Ø§: ${my_tunnel_ip:-Ù†Ø§Ù…Ø´Ø®Øµ}"
    echo "  ğŸ“¡ ÙˆØ¶Ø¹ÛŒØª Ø³Ø±ÙˆÛŒØ³: $(systemctl is-active "$SERVICE_NAME")"
}

# =============================================================================
# Ù…Ù†ÙˆÛŒ Ø§ØµÙ„ÛŒ
# =============================================================================

show_main_menu() {
    while true; do
        print_header
        
        # Ù†Ù…Ø§ÛŒØ´ ÙˆØ¶Ø¹ÛŒØª Ú©Ù„ÛŒ
        local service_status
        if systemctl is-active --quiet "$SERVICE_NAME"; then
            service_status="${GREEN}ğŸŸ¢ ÙØ¹Ø§Ù„${NC}"
        else
            service_status="${RED}ğŸ”´ ØºÛŒØ±ÙØ¹Ø§Ù„${NC}"
        fi
        
        echo -e "${CYAN}ğŸ“Š ÙˆØ¶Ø¹ÛŒØª Ø³Ø±ÙˆÛŒØ³:${NC} $service_status"
        echo -e "${CYAN}ğŸ“ Ù…Ø³ÛŒØ± Config:${NC} $CONFIG_DIR/config.yml"
        echo -e "${CYAN}ğŸ“„ Ù„Ø§Ú¯ ÙØ§ÛŒÙ„:${NC} $LOG_FILE"
        echo
        echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
        echo
        echo "1) ğŸš€ Start Service"
        echo "2) ğŸ›‘ Stop Service"  
        echo "3) ğŸ“Š Show Status"
        echo "4) ğŸ”— Manage Peers"
        echo "5) ğŸŒ Manage Network"
        echo "6) âš¡ Performance Optimization"
        echo "7) ğŸ”§ Troubleshooting"
        echo "0) ğŸšª Exit"
        echo
        read -p "Select your option [0-7]: " choice
        
        echo
        case $choice in
            1) start_service ;;
            2) stop_service ;;
            3) show_status ;;
            4) manage_peers ;;
            5) manage_network ;;
            6) performance_menu ;;
            7) troubleshooting_menu ;;
            0) 
                echo -e "${GREEN}Goodbye! ğŸ‘‹${NC}"
                exit 0
                ;;
            *)
                log_error "Invalid option. Please enter a number between 0-7."
                press_any_key
                ;;
        esac
    done
}

# =============================================================================
# Ú¯Ø²ÛŒÙ†Ù‡ 6: Ù…Ù†ÙˆÛŒ Ø¨Ù‡ÛŒÙ†Ù‡â€ŒØ³Ø§Ø²ÛŒ Performance (ØªØ³Ú© 8)
# =============================================================================

performance_menu() {
    echo -e "${CYAN}âš¡ Ø¨Ù‡ÛŒÙ†Ù‡â€ŒØ³Ø§Ø²ÛŒ Performance${NC}"
    echo
    
    while true; do
        echo -e "${CYAN}=== Ù…Ù†ÙˆÛŒ Performance ===${NC}"
        echo "1) Ø¨Ù‡ÛŒÙ†Ù‡â€ŒØ³Ø§Ø²ÛŒ Ú©Ø§Ù…Ù„ (MTU + Buffer + SysCtl)"
        echo "2) ØªÙ†Ø¸ÛŒÙ… MTU Ø¨Ù‡ÛŒÙ†Ù‡"
        echo "3) Ø¨Ù‡ÛŒÙ†Ù‡â€ŒØ³Ø§Ø²ÛŒ Buffer Sizes"
        echo "4) ØªÙ†Ø¸ÛŒÙ… SysCtl Ù‡Ø§ÛŒ Ø¶Ø±ÙˆØ±ÛŒ"
        echo "5) ØªØ³Øª Performance"
        echo "6) Ù†Ù…Ø§ÛŒØ´ ÙˆØ¶Ø¹ÛŒØª ÙØ¹Ù„ÛŒ"
        echo "7) Ø°Ø®ÛŒØ±Ù‡ ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø¯Ø§Ø¦Ù…ÛŒ"
        echo "8) Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† ØªÙ†Ø¸ÛŒÙ…Ø§Øª"
        echo "9) Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ Ù…Ù†ÙˆÛŒ Ø§ØµÙ„ÛŒ"
        echo
        read -p "Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯ [1-9]: " perf_choice
        
        case $perf_choice in
            1)
                echo -e "\n${GREEN}=== Ø¨Ù‡ÛŒÙ†Ù‡â€ŒØ³Ø§Ø²ÛŒ Ú©Ø§Ù…Ù„ ===${NC}"
                if [[ -f "utils/performance-optimizer.sh" ]]; then
                    chmod +x utils/performance-optimizer.sh
                    utils/performance-optimizer.sh optimize
                else
                    log_error "performance-optimizer.sh ÛŒØ§ÙØª Ù†Ø´Ø¯"
                fi
                ;;
            2)
                echo -e "\n${BLUE}=== ØªÙ†Ø¸ÛŒÙ… MTU ===${NC}"
                if [[ -f "utils/performance-optimizer.sh" ]]; then
                    utils/performance-optimizer.sh mtu
                else
                    log_error "performance-optimizer.sh ÛŒØ§ÙØª Ù†Ø´Ø¯"
                fi
                ;;
            3)
                echo -e "\n${BLUE}=== Ø¨Ù‡ÛŒÙ†Ù‡â€ŒØ³Ø§Ø²ÛŒ Buffers ===${NC}"
                if [[ -f "utils/performance-optimizer.sh" ]]; then
                    utils/performance-optimizer.sh buffers
                else
                    log_error "performance-optimizer.sh ÛŒØ§ÙØª Ù†Ø´Ø¯"
                fi
                ;;
            4)
                echo -e "\n${BLUE}=== ØªÙ†Ø¸ÛŒÙ… SysCtl ===${NC}"
                if [[ -f "utils/performance-optimizer.sh" ]]; then
                    utils/performance-optimizer.sh sysctl
                else
                    log_error "performance-optimizer.sh ÛŒØ§ÙØª Ù†Ø´Ø¯"
                fi
                ;;
            5)
                echo -e "\n${PURPLE}=== ØªØ³Øª Performance ===${NC}"
                if [[ -f "utils/performance-optimizer.sh" ]]; then
                    utils/performance-optimizer.sh test
                else
                    log_error "performance-optimizer.sh ÛŒØ§ÙØª Ù†Ø´Ø¯"
                fi
                ;;
            6)
                echo -e "\n${CYAN}=== ÙˆØ¶Ø¹ÛŒØª Performance ===${NC}"
                if [[ -f "utils/performance-optimizer.sh" ]]; then
                    utils/performance-optimizer.sh status
                else
                    log_error "performance-optimizer.sh ÛŒØ§ÙØª Ù†Ø´Ø¯"
                fi
                ;;
            7)
                echo -e "\n${GREEN}=== Ø°Ø®ÛŒØ±Ù‡ Ø¯Ø§Ø¦Ù…ÛŒ ===${NC}"
                if [[ -f "utils/performance-optimizer.sh" ]]; then
                    utils/performance-optimizer.sh save
                else
                    log_error "performance-optimizer.sh ÛŒØ§ÙØª Ù†Ø´Ø¯"
                fi
                ;;
            8)
                echo -e "\n${RED}=== Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† ØªÙ†Ø¸ÛŒÙ…Ø§Øª ===${NC}"
                read -p "Ø¢ÛŒØ§ Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ØŸ [y/N]: " confirm
                if [[ "$confirm" =~ ^[Yy]$ ]]; then
                    if [[ -f "utils/performance-optimizer.sh" ]]; then
                        utils/performance-optimizer.sh cleanup
                    else
                        log_error "performance-optimizer.sh ÛŒØ§ÙØª Ù†Ø´Ø¯"
                    fi
                else
                    log_info "Ø¹Ù…Ù„ÛŒØ§Øª Ù„ØºÙˆ Ø´Ø¯"
                fi
                ;;
            9)
                return
                ;;
            *)
                log_error "Ú¯Ø²ÛŒÙ†Ù‡ Ù†Ø§Ù…Ø¹ØªØ¨Ø±"
                ;;
        esac
        
        press_any_key
        echo
    done
}

# =============================================================================
# Ú¯Ø²ÛŒÙ†Ù‡ 7: Ù…Ù†ÙˆÛŒ Ø¹ÛŒØ¨â€ŒÛŒØ§Ø¨ÛŒ Ùˆ ØªØ¹Ù…ÛŒØ± (ØªØ³Ú© 10)
# =============================================================================

troubleshooting_menu() {
    echo -e "${RED}ğŸ”§ Troubleshooting & Repair${NC}"
    echo
    while true; do
        echo -e "${RED}=== Troubleshooting Menu ===${NC}"
        echo "1) Full diagnosis"
        echo "2) Auto connectivity test (ping peers)"
        echo "3) Check service status"
        echo "4) Show recent logs"
        echo "5) Auto repair"
        echo "6) Quick status"
        echo "7) Restart service (if broken)"
        echo "8) Show live logs"
        echo "9) Back to main menu"
        echo
        read -p "Select [1-9]: " trouble_choice
        case $trouble_choice in
            1)
                echo -e "\n${PURPLE}=== ØªØ´Ø®ÛŒØµ Ú©Ø§Ù…Ù„ ===${NC}"
                if [[ -f "utils/troubleshooter.sh" ]]; then
                    chmod +x utils/troubleshooter.sh
                    utils/troubleshooter.sh diagnose
                else
                    log_error "troubleshooter.sh ÛŒØ§ÙØª Ù†Ø´Ø¯"
                fi
                ;;
            2)
                echo -e "\n${BLUE}=== ØªØ³Øª Ø§ØªØµØ§Ù„ ===${NC}"
                if [[ -f "utils/troubleshooter.sh" ]]; then
                    utils/troubleshooter.sh connectivity
                else
                    log_error "troubleshooter.sh ÛŒØ§ÙØª Ù†Ø´Ø¯"
                fi
                ;;
            3)
                echo -e "\n${CYAN}=== Ø¨Ø±Ø±Ø³ÛŒ Ø³Ø±ÙˆÛŒØ³ ===${NC}"
                if [[ -f "utils/troubleshooter.sh" ]]; then
                    utils/troubleshooter.sh service
                else
                    log_error "troubleshooter.sh ÛŒØ§ÙØª Ù†Ø´Ø¯"
                fi
                ;;
            4)
                echo -e "\n${YELLOW}=== Ù„Ø§Ú¯â€ŒÙ‡Ø§ÛŒ Ø§Ø®ÛŒØ± ===${NC}"
                read -p "ØªØ¹Ø¯Ø§Ø¯ Ø®Ø·ÙˆØ· (Ù¾ÛŒØ´ÙØ±Ø¶: 20): " log_lines
                log_lines=${log_lines:-20}
                if [[ -f "utils/troubleshooter.sh" ]]; then
                    utils/troubleshooter.sh logs "$log_lines"
                else
                    log_error "troubleshooter.sh ÛŒØ§ÙØª Ù†Ø´Ø¯"
                fi
                ;;
            5)
                echo -e "\n${GREEN}=== ØªØ¹Ù…ÛŒØ± Ø®ÙˆØ¯Ú©Ø§Ø± ===${NC}"
                if [[ -f "utils/troubleshooter.sh" ]]; then
                    utils/troubleshooter.sh fix
                else
                    log_error "troubleshooter.sh ÛŒØ§ÙØª Ù†Ø´Ø¯"
                fi
                ;;
            6)
                echo -e "\n${CYAN}=== ÙˆØ¶Ø¹ÛŒØª Ø³Ø±ÛŒØ¹ ===${NC}"
                if [[ -f "utils/troubleshooter.sh" ]]; then
                    utils/troubleshooter.sh status
                else
                    log_error "troubleshooter.sh ÛŒØ§ÙØª Ù†Ø´Ø¯"
                fi
                ;;
            7)
                echo -e "\n${RED}=== Restart Ø³Ø±ÙˆÛŒØ³ ===${NC}"
                if [[ -f "utils/troubleshooter.sh" ]]; then
                    utils/troubleshooter.sh restart
                else
                    log_info "Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Ù…Ø¬Ø¯Ø¯ Ø³Ø±ÙˆÛŒØ³..."
                    systemctl restart "$SERVICE_NAME" && log_success "Ø³Ø±ÙˆÛŒØ³ Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Ø´Ø¯" || log_error "Ø®Ø·Ø§ Ø¯Ø± Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ"
                fi
                ;;
            8)
                echo -e "\n${BLUE}=== Ù„Ø§Ú¯ Ø²Ù†Ø¯Ù‡ ===${NC}"
                log_info "Ù†Ù…Ø§ÛŒØ´ Ù„Ø§Ú¯ Ø²Ù†Ø¯Ù‡ (Ctrl+C Ø¨Ø±Ø§ÛŒ Ø®Ø±ÙˆØ¬)..."
                journalctl -u "$SERVICE_NAME" -f
                ;;
            9)
                return
                ;;
            *)
                log_error "Ú¯Ø²ÛŒÙ†Ù‡ Ù†Ø§Ù…Ø¹ØªØ¨Ø±"
                ;;
        esac
        
        press_any_key
        echo
    done
}

# =============================================================================
# Ø§Ø¬Ø±Ø§ÛŒ Ø¨Ø±Ù†Ø§Ù…Ù‡
# =============================================================================

# Ø¨Ø±Ø±Ø³ÛŒ Ø¯Ø³ØªØ±Ø³ÛŒ root
if [[ $EUID -ne 0 ]]; then
    echo -e "${RED}[ERROR]${NC} Ø§ÛŒÙ† Ø§Ø³Ú©Ø±ÛŒÙ¾Øª Ø¨Ø§ÛŒØ¯ Ø¨Ø§ Ø¯Ø³ØªØ±Ø³ÛŒ root Ø§Ø¬Ø±Ø§ Ø´ÙˆØ¯"
    echo "Ø§Ø³ØªÙØ§Ø¯Ù‡: sudo $0"
    exit 1
fi

# Ø´Ø±ÙˆØ¹ Ù…Ù†ÙˆÛŒ Ø§ØµÙ„ÛŒ
show_main_menu 